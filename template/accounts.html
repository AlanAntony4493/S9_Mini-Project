{% extends "base.html" %}
{% load static %}
{% block content %}
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Accounting Software</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background-color: #f8f9fa;
            margin: 0;
            padding: 0;
        }
    
        #transactionForm {
            max-width: 400px;
            margin: 10px auto;
            background-color: #fff;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }
    
        #transactionForm label {
            display: block;
            margin-bottom: 8px;
        }
    
        #transactionForm input
         {
            width: calc(100% - 10px);
            padding: 10px;
            margin-bottom: 15px;
            box-sizing: border-box;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
    
        #transactionForm button {
            width: 100%;
            background-color: #007bff;
            color: #fff;
            padding: 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
    
        #transactionForm button:hover {
            background-color: #0056b3;
        }
    
        table {
            width: 80%;
            border-collapse: collapse;
            margin-top: 20px;
            margin-left:10%;
            margin-right:10%;
            margin-bottom:40px;
            background-color: #fff;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            overflow: hidden;
        }
    
        th,
        td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }
    
        th {
            background-color: #007bff;
            color: #fff;
        }
    
        tfoot {
            background-color: #f8f9fa;
        }
    
        button[type="button"] {
            background-color: #28a745;
            color: #fff;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
    
        button[type="button"]:hover {
            background-color: #218838;
        }

        h2 {
            font-size: 24px;
            margin-bottom: 20px;
            margin-left: 40px;
            color: #007bff;
            font-family: 'Helvetica', sans-serif;
        }
        .desc{
            width: calc(100% - 10px);
            padding: 10px;
            margin-bottom: 15px;
            box-sizing: border-box;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        /* Style for the form container */
#monthFilterForm {
    margin-top: 20px;
    margin-left: 10%;
}

/* Style for the label */
#monthFilterForm label {
    font-weight: bold;
    margin-bottom: 8px;
}

/* Style for the select dropdown */
#monthFilter {
    width: 200px;
    padding: 8px;
    border: 1px solid #ccc;
    border-radius: 4px;
}

/* Style for the selected option */
#monthFilter option[selected] {
    background-color: #007bff;
    color: #fff;
}

/* Style for the form submit button (if needed) */
#monthFilterForm button {
    margin-top: 10px;
    background-color: #007bff;
    color: #fff;
    padding: 8px 12px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
}

#monthFilterForm button:hover {
    background-color: #0056b3;
}
.button1 {
    padding: 10px 20px;
    margin-left:10%;
    font-size: 16px;
    cursor: pointer;
    background-color: #4CAF50; /* Green background color */
    color: white; /* White text color */
    border: none; /* Remove border */
    border-radius: 5px; /* Optional: Rounded corners */
}

/* Hover effect for the button */
.button1:hover {
    background-color: #45a049; /* Darker green on hover */
}

    </style>
    
</head>

<body>
    <!-- Breadcrumbs section -->
        <!-- Breadcrumbs -->
  <section class="breadcrumbs">
    <div class="container">
        <div class="d-flex justify-content-between align-items-center">
            <h2>Accounts</h2>
        </div>
    </div>
</section>
<!-- End Breadcrumbs -->


<!-- Add the following code before the table -->

<form id="monthFilterForm" method="get" action="{% url 'accounts' %}">
    <label for="monthFilter">Select Month:</label>
    <select id="monthFilter" name="month" onchange="submitMonthFilter()">
        {% for month in months %}
            <option value="{{ month.0 }}" {% if month.0 == selected_month %}selected{% endif %}>
                {{ month.1 }}
            </option>
        {% endfor %}
    </select>
</form>

<script>
    function submitMonthFilter() {
        document.getElementById('monthFilterForm').submit();
    }
</script>


<!-- Transaction Table -->
<table id="transactionTable">
    <thead>
        <tr>
            <th>Sl.No</th>
            <th>Date</th>
            <th>Description</th>
            <th>Credit</th>
            <th>Debit</th>
            <th>Bill/Invoice Number</th>
        </tr>
    </thead>
    <tbody>
        {% for transaction in transactions|dictsort:"date" %}
            <tr>
                <td>{{ forloop.counter }}</td>
                <td>{{ transaction.date }}</td>
                <td>{{ transaction.description }}{% if transaction.specify_transaction %} - {{ transaction.specify_transaction }}{% endif %}</td>
                <td>{{ transaction.credit }}</td>
                <td>{{ transaction.debit }}</td>
                <td>{{ transaction.bill_number }}</td>
            </tr>
        {% endfor %}
    </tbody>
    
    <tfoot>
        <tr>
            <td><strong>Total:</strong></td>
            <td></td>
            <td></td>
            <td id="totalCredit">{{ total_credit }}</td>
            <td id="totalDebit">{{ total_debit }}</td>
            <td></td>
        </tr>
    </tfoot>
</table>


{% comment %} Button for generating balance sheet {% endcomment %}
<button class="button1" onclick="generateBalanceSheet()">Generate Balance Sheet of this year</button>

<script>
    function generateBalanceSheet() {
        window.location.href = "{% url 'balance_sheet' %}";
    }
</script>

{% if user.registration.is_accounted_user %}
<form id="transactionForm" method="post" action="{% url 'add_transaction' %}" onsubmit="return checkBillNumber()">
        {% csrf_token %}
        <h2>ADD TRANSACTIONS</h2>
        <label for="date">Date:</label>
        <input type="date" id="date" onchange="validateTransactionDate()" required placeholder="Select date" name="date">
        <label for="description">Category:</label>
        <select id="description" class="desc" onchange="handleDescriptionChange()" required name="description">
            <option value="" disabled selected>Select Category</option>
            <option value="Food">Food</option>
            <option value="Groceries">Stationaries</option>
            <option value="Perunnal">Perunnal</option>
            <option value="Carol">Carol</option>
            <option value="Christmas_Tree">Christmas Tree</option>
            <option value="Bank">Bank</option>
            <option value="Donation">Donation</option>
            <option value="Church">Church</option>
            <option value="Pilgrimage">Pilgrimage</option>
            <option value="Fuel">Fuel</option>
            <option value="Other">Other</option>
        </select>
    
        <div id="specifyTransactionDiv">
            <label for="specifyTransaction">Description:</label>
            <input type="text" id="specifyTransaction" placeholder="Enter the description" name="specifyTransaction" required>
        </div>

        <div style="display: flex; gap: 10px;">
            <div style="flex: 1;">
                <label for="credit">Credit:</label>
                <input type="number" id="credit" oninput="validateCreditDebit()" placeholder="Enter credit amount" name="credit" required>
            </div>
            <div style="flex: 1;">
                <label for="debit">Debit:</label>
                <input type="number" id="debit" oninput="validateCreditDebit()" placeholder="Enter debit amount" name="debit" required>
            </div>
        </div>

        <label for="billNumber">Bill/Invoice Number:</label>
        <input type="text" id="billNumber" pattern="[a-zA-Z0-9]+" title="Should contain only letters and numbers" required
            placeholder="Enter bill/invoice number" name="billNumber">
        <button type="submit">Add Transaction</button>
        <input type="hidden" id="existingBillNumbers" value="{{ existing_bill_numbers }}">
    </form>
    

 {% endif %}

    <script>
        function handleDescriptionChange() {
            var descriptionDropdown = document.getElementById('description');
            var specifyTransactionDiv = document.getElementById('specifyTransactionDiv');
            var specifyTransactionInput = document.getElementById('specifyTransaction');
        
            specifyTransactionDiv.style.display = 'block'; // Always show the field
        
            if (descriptionDropdown.value === 'Other') {
                specifyTransactionInput.required = true;
            } else {
                specifyTransactionInput.required = false;
            }
        }
        
        function validateCreditDebit() {
            var creditInput = document.getElementById('credit');
            var debitInput = document.getElementById('debit');
        
            var credit = parseFloat(creditInput.value);
            var debit = parseFloat(debitInput.value);
        
            if (isNaN(credit) || credit < 0) {
                // Invalid or negative credit value
                creditInput.value = '';
                credit = 0;
            }
        
            if (isNaN(debit) || debit < 0) {
                // Invalid or negative debit value
                debitInput.value = '';
                debit = 0;
            }
        
            if (credit !== 0) {
                debitInput.disabled = true;
            } else if (debit !== 0) {
                creditInput.disabled = true;
            } else {
                creditInput.disabled = false;
                debitInput.disabled = false;
            }
        }
        

        function validateTransactionDate() {
            var dateInput = document.getElementById('date');
            var selectedDate = new Date(dateInput.value);
            var currentDate = new Date();

            var startOfMonth = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);

            if (selectedDate < startOfMonth || selectedDate > currentDate) {
                alert("You can only select dates in the current month and up to today.");
                dateInput.value = '';
            }
        }

            function checkBillNumber() {
                var billNumberInput = document.getElementById('billNumber');
                var billNumber = billNumberInput.value.trim();
        
                // Check if the bill number already exists in the hidden input's value
                var existingBillNumbers = document.getElementById('existingBillNumbers').value;
                var billNumbersArray = existingBillNumbers.split(',');
        
                if (billNumbersArray.includes(billNumber)) {
                    // Bill number already exists, show an alert
                    alert('Bill number already exists. Please enter a different one.');
                    return false;  // Prevent the form submission
                } else {
                    // Bill number is unique, allow form submission
                    return true;
                }
            }
      
        
    </script>
    <!-- Add the following script at the end of the accounts.html template -->
<script>
    {% if error_message %}
        alert('{{ error_message }}');
    {% endif %}
</script>

</body>

</html>
{% endblock %}

